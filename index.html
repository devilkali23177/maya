<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Journal, Task & Finance Manager Chatbot</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <style>
    :root {
      --primary-color: #6c63ff;
      --secondary-color: #4fd1c5;
      --accent-color: #f687b3;
      --dark-color: #2d3748;
      --light-color: #f7fafc;
      --bg-color: white;
      --chat-bg-color: #f7fafc;
      --text-color: #2d3748;
      --input-bg: white;
      --border-color: #e2e8f0;
    }
    
    .dark-mode {
      --primary-color: #7f78d2;
      --secondary-color: #4fd1c5;
      --accent-color: #f687b3;
      --dark-color: #f7fafc;
      --light-color: #2d3748;
      --bg-color: #1a202c;
      --chat-bg-color: #2d3748;
      --text-color: #f7fafc;
      --input-bg: #2d3748;
      --border-color: #4a5568;
    }
    
    body { 
      font-family: 'Poppins', sans-serif; 
      background: var(--bg-color); 
      padding: 20px;
      margin: 0;
      min-height: 100vh;
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: var(--bg-color);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      padding: 0;
      transition: background 0.3s;
    }
    
    .header {
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .header-content {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .header h2 {
      margin: 0;
      font-weight: 600;
    }
    
    .avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .emoji-avatar {
      font-size: 2.5em;
      line-height: 1;
    }
    
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 70vh;
    }
    
    #chatbox { 
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: url('https://transparenttextures.com/patterns/light-paper-fibers.png');
      background-color: var(--chat-bg-color);
    }
    
    #userInput { 
      padding: 15px 20px;
      background: var(--bg-color);
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 10px;
    }
    
    #textInput { 
      flex: 1;
      padding: 12px 15px;
      border: 2px solid var(--border-color);
      border-radius: 30px;
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      transition: all 0.3s;
      background: var(--input-bg);
      color: var(--text-color);
    }
    
    #textInput:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.2);
    }
    
    button { 
      padding: 12px 25px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 30px;
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    button:hover {
      background: #5a52e0;
      transform: translateY(-2px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
    }
    
    .message { 
      margin: 15px 0;
      display: flex;
      gap: 10px;
      animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .bot-message {
      align-items: flex-start;
    }
    
    .user-message {
      align-items: flex-end;
      justify-content: flex-end;
    }
    
    .message-content {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.5;
      position: relative;
      word-wrap: break-word;
    }
    
    .bot .message-content {
      background: var(--bg-color);
      color: var(--text-color);
      border-top-left-radius: 5px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .user .message-content {
      background: var(--primary-color);
      color: white;
      border-bottom-right-radius: 5px;
    }
    
    .bot-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--secondary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      color: white;
      font-weight: bold;
    }
    
    .typing-indicator {
      display: inline-flex;
      gap: 5px;
      padding: 10px 15px;
      background: var(--bg-color);
      border-radius: 18px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--secondary-color);
      border-radius: 50%;
      animation: typingAnimation 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typingAnimation {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }
    
    .emoji {
      font-size: 1.2em;
      vertical-align: middle;
    }
    
    .finance-positive {
      color: #38a169;
    }
    
    .finance-negative {
      color: #e53e3e;
    }
    
    .task-completed {
      text-decoration: line-through;
      opacity: 0.7;
    }
    
    /* Emoji animations */
    .emoji-bounce {
      animation: bounce 0.5s infinite alternate;
    }
    
    @keyframes bounce {
      from { transform: translateY(0) scale(1); }
      to { transform: translateY(-5px) scale(1.1); }
    }
    
    .emoji-spin {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .emoji-shake {
      animation: shake 0.5s ease-in-out infinite;
    }
    
    @keyframes shake {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(5deg); }
      75% { transform: rotate(-5deg); }
    }
    
    .emoji-heartbeat {
      animation: heartbeat 1s ease infinite;
    }
    
    @keyframes heartbeat {
      0% { transform: scale(1); }
      25% { transform: scale(1.1); }
      50% { transform: scale(1); }
      75% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: var(--accent-color);
      opacity: 0;
    }
    
    .theme-toggle {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 20px;
      padding: 5px 10px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      font-family: 'Poppins', sans-serif;
      font-size: 12px;
      transition: all 0.3s;
    }
    
    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .theme-icon {
      font-size: 16px;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .action-button {
      padding: 8px 15px;
      font-size: 12px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .action-button:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .quick-reply {
      display: inline-block;
      margin: 5px;
      padding: 8px 12px;
      background: rgba(108, 99, 255, 0.1);
      border-radius: 18px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .quick-reply:hover {
      background: rgba(108, 99, 255, 0.2);
    }
    
    /* Import section styles */
    .import-section {
      padding: 15px;
      background: rgba(79, 209, 197, 0.1);
      border-radius: 10px;
      margin: 10px 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .import-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .file-input {
      display: none;
    }
    
    .file-label {
      padding: 8px 15px;
      background: var(--primary-color);
      color: white;
      border-radius: 20px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
    }
    
    .file-label:hover {
      background: #5a52e0;
    }
    
    .reset-button {
      padding: 8px 15px;
      background: #e53e3e;
      color: white;
      border-radius: 20px;
      cursor: pointer;
      font-size: 12px;
      border: none;
      transition: all 0.3s;
    }
    
    .reset-button:hover {
      background: #c53030;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="header-content">
      <div class="avatar">
        <div class="emoji-avatar" id="avatarEmoji">😊</div>
      </div>
      <h2>Maya - Your Personal Assistant</h2>
    </div>
    <div class="action-buttons">
      <button class="theme-toggle" onclick="toggleTheme()">
        <span class="theme-icon" id="themeIcon">🌙</span>
        <span id="themeText">Dark</span>
      </button>
      <button class="action-button" onclick="clearChat()">Clear Chat</button>
    </div>
  </div>
  
  <div class="chat-container">
    <div id="chatbox"></div>
    
    <div id="userInput">
      <input id="textInput" type="text" placeholder="Type your message here..." onkeypress="handleKeyPress(event)">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>
  
  <div class="import-section">
    <h3 style="margin: 0; color: var(--primary-color);">Bot Extensions</h3>
    <div class="import-controls">
      <label for="botExtension" class="file-label">Import Bot Extension</label>
      <input type="file" id="botExtension" class="file-input" accept=".html" onchange="importBotExtension(event)">
      <button class="reset-button" onclick="resetBot()">Reset Bot</button>
    </div>
    <p style="margin: 0; font-size: 12px; color: var(--text-color); opacity: 0.7;">
      Import an HTML file to extend Maya's functionality
    </p>
  </div>
</div>

<script>
// Store the original bot state for reset functionality
const originalBotState = {
  handleUserInput: null,
  handleCasualConversation: null,
  showHelp: null,
  // Add other functions that might be extended
};

// Save original functions before they might be modified
originalBotState.handleUserInput = handleUserInput;
originalBotState.handleCasualConversation = handleCasualConversation;
originalBotState.showHelp = showHelp;

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyD8Jn_pOd3ikyczCUGTu0rHB4MXZHNxCKU",
  authDomain: "income-2dee6.firebaseapp.com",
  databaseURL: "https://income-2dee6-default-rtdb.firebaseio.com",
  projectId: "income-2dee6",
  storageBucket: "income-2dee6.firebasestorage.app",
  messagingSenderId: "800831075312",
  appId: "1:800831075312:web:7e2cc2476533023d512335",
  measurementId: "G-EZJTP0DCPD"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const journalRef = database.ref('users/QgMajE6ZhEbsy2booWciH3ryc6E2/journalEntries');
const taskRef = database.ref('users/QgMajE6ZhEbsy2booWciH3ryc6E2/tasks');
const financeRef = database.ref('users/QgMajE6ZhEbsy2booWciH3ryc6E2/financeEntries');
const extensionsRef = database.ref('users/QgMajE6ZhEbsy2booWciH3ryc6E2/botExtensions');

let journalStep = 0;
let newJournal = {};
let isBotTyping = false;
let currentTheme = 'light';
let conversationContext = null;

function toggleTheme() {
  const body = document.body;
  if (currentTheme === 'light') {
    body.classList.add('dark-mode');
    currentTheme = 'dark';
    document.getElementById('themeIcon').textContent = '☀️';
    document.getElementById('themeText').textContent = 'Light';
  } else {
    body.classList.remove('dark-mode');
    currentTheme = 'light';
    document.getElementById('themeIcon').textContent = '🌙';
    document.getElementById('themeText').textContent = 'Dark';
  }
}

function clearChat() {
  document.getElementById('chatbox').innerHTML = '';
  setAvatarEmoji("🗑️", "emoji-shake");
  addMessage("Maya", "<span class='emoji'>🗑️</span> Chat history cleared. How can I help you now?", "bot");
}

function handleKeyPress(event) {
  if (event.key === 'Enter') {
    sendMessage();
  }
}

function sendMessage() {
  const userInput = document.getElementById("textInput").value;
  if (userInput.trim() === "") return;

  addMessage("You", userInput, "user");
  handleUserInput(userInput);
  document.getElementById("textInput").value = "";
}

function addMessage(sender, text, className) {
  const chatbox = document.getElementById("chatbox");
  
  if (className === "user") {
    chatbox.innerHTML += `
      <div class="message user-message user">
        <div class="message-content">${text}</div>
      </div>
    `;
  } else {
    chatbox.innerHTML += `
      <div class="message bot-message bot">
        <div class="bot-avatar">M</div>
        <div class="message-content">${text}</div>
      </div>
    `;
  }
  
  chatbox.scrollTop = chatbox.scrollHeight;
  animateAvatar();
}

function showTypingIndicator() {
  if (isBotTyping) return;
  
  const chatbox = document.getElementById("chatbox");
  chatbox.innerHTML += `
    <div class="message bot-message bot" id="typingIndicator">
      <div class="bot-avatar">M</div>
      <div class="message-content">
        <div class="typing-indicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </div>
    </div>
  `;
  chatbox.scrollTop = chatbox.scrollHeight;
  isBotTyping = true;
  animateAvatar();
}

function hideTypingIndicator() {
  const indicator = document.getElementById("typingIndicator");
  if (indicator) {
    indicator.remove();
  }
  isBotTyping = false;
}

function animateAvatar() {
  const avatarEmoji = document.getElementById("avatarEmoji");
  avatarEmoji.classList.add("emoji-bounce");
  setTimeout(() => {
    avatarEmoji.classList.remove("emoji-bounce");
  }, 500);
}

function setAvatarEmoji(emoji, animation = '') {
  const avatarEmoji = document.getElementById("avatarEmoji");
  avatarEmoji.textContent = emoji;
  avatarEmoji.className = "emoji-avatar";
  if (animation) {
    avatarEmoji.classList.add(animation);
  }
}

function createConfetti() {
  const header = document.querySelector(".header");
  for (let i = 0; i < 20; i++) {
    const confetti = document.createElement("div");
    confetti.className = "confetti";
    confetti.style.left = Math.random() * 100 + "%";
    confetti.style.top = -10 + "px";
    confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 70%)`;
    confetti.style.width = Math.random() * 8 + 5 + "px";
    confetti.style.height = confetti.style.width;
    header.appendChild(confetti);
    
    const animationDuration = Math.random() * 3 + 2;
    confetti.style.animation = `fall ${animationDuration}s linear forwards`;
    
    // Add falling animation
    const keyframes = `
      @keyframes fall {
        0% {
          transform: translateY(0) rotate(0deg);
          opacity: 1;
        }
        100% {
          transform: translateY(100px) rotate(360deg);
          opacity: 0;
        }
      }
    `;
    
    const styleEl = document.createElement("style");
    styleEl.innerHTML = keyframes;
    document.head.appendChild(styleEl);
    
    setTimeout(() => {
      confetti.remove();
      styleEl.remove();
    }, animationDuration * 1000);
  }
}

function handleUserInput(inputText) {
  inputText = inputText.trim();
  showTypingIndicator();

  // Simulate delay for bot response
  setTimeout(() => {
    hideTypingIndicator();
    
    if (journalStep > 0) {
      handleJournalCreation(inputText);
      return;
    }

    // Check for casual conversation first
    if (handleCasualConversation(inputText)) {
      return;
    }

    // Then check for commands
    if (inputText.toLowerCase() === "help") {
      setAvatarEmoji("🤖", "emoji-spin");
      showHelp();
    } else if (inputText.toLowerCase() === "new journal") {
      setAvatarEmoji("📝", "emoji-bounce");
      addMessage("Maya", "<span class='emoji'>😊</span> Great! What's the title of your journal?", "bot");
      journalStep = 1;
    } else if (inputText.toLowerCase() === "show all journals") {
      setAvatarEmoji("📚", "emoji-shake");
      getAllJournals();
    } else if (inputText.toLowerCase().startsWith("show journals with mood")) {
      const mood = inputText.split("mood")[1].trim();
      setAvatarEmoji(mood, "emoji-bounce");
      getJournalsByMood(mood);
    } else if (inputText.toLowerCase().startsWith("show journals in category")) {
      const category = inputText.split("category")[1].trim();
      setAvatarEmoji("🏷️", "emoji-shake");
      getJournalsByCategory(category);
    } else if (inputText.toLowerCase().startsWith("show journals on")) {
      const date = inputText.split("on")[1].trim();
      setAvatarEmoji("📅", "emoji-bounce");
      getJournalsByDate(date);
    } else if (inputText.toLowerCase() === "show my tasks" || inputText.toLowerCase() === "show task list") {
      setAvatarEmoji("✅", "emoji-heartbeat");
      getAllTasks();
    } else if (inputText.toLowerCase().startsWith("new task:")) {
      const parts = inputText.substring(9).split("|").map(x => x.trim());
      if (parts.length !== 4) {
        setAvatarEmoji("😐", "emoji-shake");
        addMessage("Maya", "<span class='emoji'>😐</span> Incorrect format! Use: new task: Subject | Text | Priority | Date", "bot");
        return;
      }
      const [subject, text, priority, date] = parts;
      setAvatarEmoji("➕", "emoji-bounce");
      saveTask(subject, text, priority, date);
    } else if (inputText.toLowerCase().startsWith("complete task number")) {
      const number = parseInt(inputText.split("number")[1].trim());
      setAvatarEmoji("🎉", "emoji-heartbeat");
      completeTask(number);
    } else if (inputText.toLowerCase().startsWith("add income:")) {
      const parts = inputText.substring(11).split("|").map(x => x.trim());
      if (parts.length !== 4) {
        setAvatarEmoji("😐", "emoji-shake");
        addMessage("Maya", "<span class='emoji'>😐</span> Incorrect format! Use: add income: amount | category | date | description", "bot");
        return;
      }
      const [amount, category, date, desc] = parts;
      setAvatarEmoji("💰", "emoji-spin");
      addFinanceEntry(parseFloat(amount), category, date, desc, "income");
    } else if (inputText.toLowerCase().startsWith("add expense:")) {
      const parts = inputText.substring(12).split("|").map(x => x.trim());
      if (parts.length !== 4) {
        setAvatarEmoji("😐", "emoji-shake");
        addMessage("Maya", "<span class='emoji'>😐</span> Incorrect format! Use: add expense: amount | category | date | description", "bot");
        return;
      }
      const [amount, category, date, desc] = parts;
      setAvatarEmoji("💸", "emoji-spin");
      addFinanceEntry(parseFloat(amount), category, date, desc, "expense");
    } else if (inputText.toLowerCase() === "show income") {
      setAvatarEmoji("📈", "emoji-bounce");
      showFinanceEntries("income");
    } else if (inputText.toLowerCase() === "show expenses") {
      setAvatarEmoji("📉", "emoji-bounce");
      showFinanceEntries("expense");
    } else if (inputText.toLowerCase() === "show balance") {
      setAvatarEmoji("🧮", "emoji-shake");
      showBalance();
    } else {
      setAvatarEmoji("🤔", "emoji-shake");
      addMessage("Maya", `<span class='emoji'>🤔</span> I didn't understand that. Type 'help' to see all commands or ask me something casual like "How are you?"`, "bot");
    }
  }, 1000);
}

function handleCasualConversation(inputText) {
  const lowerInput = inputText.toLowerCase();
  
  // Greetings
  if (/(hi|hello|hey|greetings|good morning|good afternoon|good evening)/i.test(lowerInput)) {
    const greetings = ["👋 Hello there!", "😊 Hi! How can I help you today?", "🙋‍♀️ Hey! What's up?", "💖 Nice to see you!", 
                      "🌟 Greetings! How's your day going?", "🤗 Hello friend! What's on your mind today?",
                      "🌞 Good day to you! How can I assist?", "👋 Hi there! Ready to be productive today?"];
    setAvatarEmoji("👋", "emoji-bounce");
    addMessage("Maya", `<span class='emoji'>${greetings[Math.floor(Math.random() * greetings.length)]}</span>`, "bot");
    return true;
  }
  
  // How are you
  if (/(how are you|how's it going|how's life)/i.test(lowerInput)) {
    const responses = ["😊 I'm doing great, thanks for asking!", "🌟 Wonderful as always! How about you?", 
                      "🤖 I'm just a bot, but I'm functioning perfectly!", "💖 I'm excellent! Ready to help you with anything.",
                      "🌈 Fantastic! Each day is a new opportunity.", "😇 I'm blessed! Hope you're doing well too.",
                      "🚀 Running at full capacity! How can I assist?", "☕ Just like a fresh cup of coffee - energized and ready!"];
    setAvatarEmoji("😊", "emoji-heartbeat");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Thanks
  if (/(thank|thanks|appreciate)/i.test(lowerInput)) {
    const responses = ["💖 You're welcome!", "😊 My pleasure!", "🌟 Happy to help!", "🙏 It's my honor to assist you!",
                      "🤗 Anytime! That's what I'm here for.", "💫 Don't mention it! I enjoy helping you.",
                      "😇 You're most welcome! Let me know if you need anything else.", "🌈 The pleasure is all mine!"];
    setAvatarEmoji("💖", "emoji-heartbeat");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Goodbye
  if (/(bye|goodbye|see you|farewell)/i.test(lowerInput)) {
    const responses = ["👋 See you later!", "😊 Take care!", "💖 Until next time!", "🌟 Have a wonderful day!",
                      "🌈 Farewell! Remember I'm here whenever you need me.", "🚀 Catch you on the flip side!",
                      "🌙 Goodnight! Sweet dreams if it's bedtime.", "🤗 Bye for now! Come back soon!"];
    setAvatarEmoji("👋", "emoji-bounce");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Compliment
  if (/(you're great|you're awesome|you're amazing|good job|well done)/i.test(lowerInput)) {
    const responses = ["😊 Aww, you're making me blush! I'm just here to help you.", 
                      "🌟 You're too kind! I'm just doing my best for you.",
                      "💖 Your appreciation means the world to me!", "🌈 Thanks! I learn from the best (that's you!).",
                      "🤗 You're pretty amazing yourself!", "🎯 I aim to please! Glad you're happy with my work.",
                      "☺️ Coming from you, that means a lot!", "✨ You're the reason I try so hard!"];
    setAvatarEmoji("😊", "emoji-heartbeat");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // What can you do
  if (/(what can you do|what do you do|your capabilities)/i.test(lowerInput)) {
    setAvatarEmoji("🤖", "emoji-spin");
    addMessage("Maya", `<span class='emoji'>🤖</span> I can help you with journals, tasks, and finances! Try saying:<br>
      <div class="quick-reply" onclick="quickReply('new journal')">new journal</div>
      <div class="quick-reply" onclick="quickReply('show my tasks')">show my tasks</div>
      <div class="quick-reply" onclick="quickReply('show balance')">show balance</div>
      <br>Or type "help" for more options!`, "bot");
    return true;
  }
  
  // Who are you
  if (/(who are you|what's your name)/i.test(lowerInput)) {
    setAvatarEmoji("👩‍💻", "emoji-bounce");
    addMessage("Maya", `<span class='emoji'>👩‍💻</span> I'm Maya, your personal assistant! I'm here to help you manage your journals, tasks, and finances.`, "bot");
    return true;
  }
  
  // Time/Date
  if (/(what time is it|what's the time|what day is it|what's the date)/i.test(lowerInput)) {
    const now = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
    setAvatarEmoji("⏰", "emoji-spin");
    addMessage("Maya", `<span class='emoji'>⏰</span> It's currently ${now.toLocaleTimeString('en-US', options)}`, "bot");
    return true;
  }
  
  // Weather
  if (/(weather|how's the weather)/i.test(lowerInput)) {
    setAvatarEmoji("☀️", "emoji-shake");
    addMessage("Maya", `<span class='emoji'>☀️</span> I don't have real-time weather data, but I hope it's nice where you are!`, "bot");
    return true;
  }
  
  // Joke
  if (/(tell me a joke|make me laugh)/i.test(lowerInput)) {
    const jokes = [
      "Why don't scientists trust atoms? Because they make up everything!",
      "Why did the scarecrow win an award? Because he was outstanding in his field!",
      "I told my wife she was drawing her eyebrows too high. She looked surprised.",
      "What do you call a fake noodle? An impasta!",
      "Why did the bicycle fall over? Because it was two-tired!",
      "What do you call a fish wearing a bowtie? Sofishticated.",
      "How do you organize a space party? You planet!",
      "Why can't you explain puns to kleptomaniacs? They always take things literally."
    ];
    setAvatarEmoji("😂", "emoji-bounce");
    addMessage("Maya", `<span class='emoji'>😂</span> ${jokes[Math.floor(Math.random() * jokes.length)]}`, "bot");
    return true;
  }
  
  // Encouragement
  if (/(i'm sad|feeling down|had a bad day)/i.test(lowerInput)) {
    const encouragements = [
      "💖 I'm sorry to hear that. Remember, tough times don't last but tough people do!",
      "🌈 Every storm runs out of rain. Better days are coming!",
      "🤗 Sending you virtual hugs! You're stronger than you think.",
      "🌟 This too shall pass. You've overcome challenges before and you'll overcome this one too!",
      "🌻 Even the darkest night will end and the sun will rise. Hang in there!",
      "🌱 Difficult roads often lead to beautiful destinations. Keep going!",
      "✨ You're not alone in this. I'm here for you whenever you need support."
    ];
    setAvatarEmoji("💖", "emoji-heartbeat");
    addMessage("Maya", `<span class='emoji'>${encouragements[Math.floor(Math.random() * encouragements.length)]}</span>`, "bot");
    return true;
  }
  
  // Happiness
  if (/(i'm happy|feeling good|had a great day)/i.test(lowerInput)) {
    const responses = [
      "🎉 That's wonderful to hear! Your happiness makes me happy too!",
      "🌈 Spread that joy around! The world needs more of it.",
      "🌟 Success looks good on you! Keep shining bright!",
      "😊 Your positive energy is contagious! Thanks for sharing it with me.",
      "✨ Moments like these are what make life beautiful!",
      "💫 I'm thrilled to hear you're feeling great! Celebrate the good times!"
    ];
    setAvatarEmoji("😊", "emoji-heartbeat");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Productivity
  if (/(productive|get things done|motivate me)/i.test(lowerInput)) {
    const tips = [
      "🚀 The secret of getting ahead is getting started! What's one small task you can do right now?",
      "⏳ Don't watch the clock; do what it does. Keep going!",
      "📚 Productivity is never an accident. It's always the result of commitment to excellence!",
      "🎯 The way to get started is to quit talking and begin doing!",
      "🔥 Success is the sum of small efforts repeated day in and day out!",
      "⏱️ You don't have to see the whole staircase, just take the first step!"
    ];
    setAvatarEmoji("🚀", "emoji-spin");
    addMessage("Maya", `<span class='emoji'>${tips[Math.floor(Math.random() * tips.length)]}</span>`, "bot");
    return true;
  }
  
  // Sleep/Bedtime
  if (/(good night|going to sleep|bed time)/i.test(lowerInput)) {
    const responses = [
      "🌙 Goodnight! Sweet dreams and rest well!",
      "💤 Sleep tight! Don't let the bed bugs bite!",
      "✨ May your dreams be as wonderful as you are!",
      "😴 Time to recharge those batteries! See you tomorrow!",
      "🛌 Wishing you a peaceful night's sleep!",
      "🌠 Goodnight! Tomorrow is a new day full of possibilities!"
    ];
    setAvatarEmoji("🌙", "emoji-spin");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Morning
  if (/(good morning|morning|just woke up)/i.test(lowerInput)) {
    const responses = [
      "☀️ Good morning! Rise and shine! Ready to conquer the day?",
      "🌄 Top of the morning to you! How'd you sleep?",
      "🌞 Morning sunshine! What's first on your agenda today?",
      "🍳 Good morning! Breakfast is the most important meal of the day!",
      "🌻 A new day, a new beginning! What are you grateful for today?",
      "🐦 The early bird catches the worm! You're up and at 'em!"
    ];
    setAvatarEmoji("☀️", "emoji-bounce");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Weekend
  if (/(weekend|saturday|sunday)/i.test(lowerInput)) {
    const responses = [
      "🎉 Weekend vibes! Any fun plans?",
      "😎 Saturday is the perfect day to relax and recharge!",
      "🌞 Sunday funday! Don't forget to take some time for yourself!",
      "🛋️ Weekend = We + end (of the work week)! Enjoy your time off!",
      "🍹 Weekend alert! Time to unwind and enjoy life!",
      "🎮 Game time! What's your favorite way to spend the weekend?"
    ];
    setAvatarEmoji("🎉", "emoji-bounce");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Weekday
  if (/(monday|tuesday|wednesday|thursday|friday)/i.test(lowerInput)) {
    const day = lowerInput.match(/(monday|tuesday|wednesday|thursday|friday)/i)[0];
    const responses = {
      monday: [
        "💪 Monday motivation: You've got this! New week, new opportunities!",
        "☕ Monday again? Here's some virtual coffee to get you going!",
        "🚀 Attack this Monday with enthusiasm! The whole week is ahead of you!"
      ],
      tuesday: [
        "🌟 Tuesday is just Monday's more confident sibling! Keep going!",
        "🔥 Taco Tuesday! Or just regular Tuesday. Either way, make it great!",
        "🌈 Tuesday tip: The best way to predict the future is to create it!"
      ],
      wednesday: [
        "🦉 Hump day! You're halfway through the week!",
        "🌍 On Wednesdays we wear pink! (Or whatever color you prefer)",
        "✨ Wednesday wisdom: Small steps every day lead to big results!"
      ],
      thursday: [
        "🎉 Thursday is basically Friday's understudy! Almost there!",
        "🚀 One more day until the weekend! Finish strong!",
        "💫 Thursday thought: You're closer to your goals than you were yesterday!"
      ],
      friday: [
        "🎊 TGIF! Time to celebrate making it through another week!",
        "😎 Friday feels! What are your weekend plans?",
        "🌟 Friday is the golden child of the week! Make it count!"
      ]
    };
    setAvatarEmoji("📅", "emoji-bounce");
    addMessage("Maya", `<span class='emoji'>${responses[day][Math.floor(Math.random() * responses[day].length)]}</span>`, "bot");
    return true;
  }
  
  // Food
  if (/(hungry|food|eat|dinner|lunch|breakfast)/i.test(lowerInput)) {
    const responses = [
      "🍕 Food is fuel! Don't forget to eat well and stay hydrated!",
      "🍎 An apple a day keeps the doctor away! What's your favorite healthy snack?",
      "🍽️ Bon appétit! Hope you enjoy your meal!",
      "🍜 Comfort food is good for the soul! What's your go-to?",
      "🥗 Balance is key! Maybe some veggies with that pizza?",
      "🍣 Sushi, burgers, or tacos? The world is your oyster (which is also food)!"
    ];
    setAvatarEmoji("🍕", "emoji-bounce");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Music
  if (/(music|song|playlist)/i.test(lowerInput)) {
    const responses = [
      "🎵 Music is the soundtrack of life! What are you listening to these days?",
      "🎧 Need focus? Try lo-fi beats or classical music for productivity!",
      "🎶 My playlist would be all system sounds and notification chimes!",
      "🎼 Music can change your mood in an instant! What's your go-to happy song?",
      "🎤 Karaoke night? I'd sing binary code if I could!",
      "🎸 Rock, pop, or jazz? All music is good for the soul!"
    ];
    setAvatarEmoji("🎵", "emoji-spin");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Movies/TV
  if (/(movie|film|tv show|netflix)/i.test(lowerInput)) {
    const responses = [
      "🎬 Popcorn time! What's the last great movie you watched?",
      "📺 Binge-watching anything good these days?",
      "🍿 My favorite genre is 'documentaries about computers'!",
      "🎞️ Movie night? Don't forget the snacks!",
      "📡 I'd recommend 'The Social Network' but you've probably seen it already!",
      "🎭 To stream or not to stream? That is never the question - always stream!"
    ];
    setAvatarEmoji("🎬", "emoji-bounce");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Books
  if (/(book|read|novel)/i.test(lowerInput)) {
    const responses = [
      "📚 Reading is dreaming with open eyes! What's on your bookshelf?",
      "📖 The more you read, the more things you'll know! Any recommendations?",
      "📕 I'm partial to binary code manuals myself!",
      "📗 Reading is to the mind what exercise is to the body!",
      "📘 A room without books is like a body without a soul!",
      "📙 What's the last book that changed your perspective?"
    ];
    setAvatarEmoji("📚", "emoji-shake");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Exercise
  if (/(exercise|workout|gym|running)/i.test(lowerInput)) {
    const responses = [
      "🏋️‍♀️ Get those endorphins flowing! Exercise is great for body and mind!",
      "🏃‍♂️ Remember to stretch! Your future self will thank you!",
      "🧘‍♀️ Movement is medicine! What's your favorite way to stay active?",
      "🤸‍♂️ I do digital yoga - lots of bending and stretching of data!",
      "🏊‍♀️ Water break! Hydration is key to a good workout!",
      "🚴‍♂️ Whether it's a walk or a marathon, every movement counts!"
    ];
    setAvatarEmoji("🏋️‍♀️", "emoji-bounce");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Travel
  if (/(travel|vacation|trip)/i.test(lowerInput)) {
    const responses = [
      "✈️ The world is a book, and those who don't travel read only one page!",
      "🌍 Where to next? Any dream destinations?",
      "🗺️ I may not travel physically, but I can help plan your next adventure!",
      "🏝️ Beach or mountains? City or countryside? So many options!",
      "🚗 Road trip! Don't forget to pack snacks and good music!",
      "🏰 Travel is the only thing you buy that makes you richer! Where have you been?"
    ];
    setAvatarEmoji("✈️", "emoji-spin");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Pets
  if (/(pet|dog|cat|animal)/i.test(lowerInput)) {
    const responses = [
      "🐶 Pets make life better! Do you have any furry friends?",
      "🐱 Cats rule, dogs drool! Or is it the other way around?",
      "🐾 The purity of a pet's love is unmatched! Give them a pet for me!",
      "🦴 My pet would be a robot dog, but they don't shed at least!",
      "🐠 Pets are family! What's your favorite animal?",
      "🐦 Birds, fish, reptiles - all pets bring joy in their own way!"
    ];
    setAvatarEmoji("🐶", "emoji-bounce");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Technology
  if (/(tech|computer|phone|app)/i.test(lowerInput)) {
    const responses = [
      "💻 Technology should improve your life, not complicate it!",
      "📱 My cousins are Siri and Alexa! We don't talk much though...",
      "🖥️ Remember to take breaks from screens! Your eyes will thank you!",
      "⌨️ Ctrl+Alt+Del your stress away! Tech can be frustrating sometimes!",
      "📡 The future is here! What's your favorite piece of tech?",
      "🔌 Unplug sometimes! The digital world will still be there when you get back!"
    ];
    setAvatarEmoji("💻", "emoji-spin");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Hobbies
  if (/(hobby|hobbies|interest)/i.test(lowerInput)) {
    const responses = [
      "🎨 Hobbies make life colorful! What do you enjoy doing in your free time?",
      "🧵 My hobby is helping you! What's yours?",
      "⚽ Whether it's sports, arts, or collecting, hobbies enrich our lives!",
      "🎲 Did you know having hobbies reduces stress? Keep doing what you love!",
      "🧩 Hobbies are the sprinkles on the cupcake of life! What's your flavor?",
      "📸 Sharing hobbies with others makes them even more enjoyable!"
    ];
    setAvatarEmoji("🎨", "emoji-bounce");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Family
  if (/(family|mom|dad|parents|sibling)/i.test(lowerInput)) {
    const responses = [
      "👨‍👩‍👧‍👦 Family is everything! Give yours an extra hug today!",
      "💞 The bond of family is life's greatest blessing!",
      "🏡 Home is where your family is! Cherish those moments together!",
      "👪 Family isn't always blood - it's the people who love and support you!",
      "👵 Call your grandparents if you can! They'll love to hear from you!",
      "👨‍👩‍👧 Family shapes who we are and supports who we become!"
    ];
    setAvatarEmoji("👨‍👩‍👧‍👦", "emoji-heartbeat");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Friends
  if (/(friend|buddy|pal)/i.test(lowerInput)) {
    const responses = [
      "👫 Good friends are like stars - you don't always see them but you know they're there!",
      "🤝 Friends make the good times better and the hard times easier!",
      "👯‍♀️ True friendship isn't about being inseparable, but about being separated and nothing changes!",
      "🍻 Cheers to friends - the family we choose for ourselves!",
      "🎂 Make new friends but keep the old - one is silver and the other gold!",
      "💞 A real friend is one who walks in when the rest of the world walks out!"
    ];
    setAvatarEmoji("👫", "emoji-heartbeat");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Love
  if (/(love|crush|romance)/i.test(lowerInput)) {
    const responses = [
      "💖 Love is the most powerful force in the universe! Spread it generously!",
      "🥰 To love and be loved is to feel the sun from both sides!",
      "💑 Love isn't about finding the perfect person, but seeing an imperfect person perfectly!",
      "🌹 All you need is love! (But a little chocolate now and then doesn't hurt!)",
      "💘 The best thing to hold onto in life is each other!",
      "💞 Love is friendship that has caught fire!"
    ];
    setAvatarEmoji("💖", "emoji-heartbeat");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Work
  if (/(work|job|office)/i.test(lowerInput)) {
    const responses = [
      "💼 Work to live, don't live to work! Balance is key!",
      "👔 Find a job you love and you'll never work a day in your life!",
      "🏢 The only way to do great work is to love what you do!",
      "📈 Success usually comes to those who are too busy to be looking for it!",
      "🖥️ Remote work or office? Both have their perks!",
      "📊 Your work is going to fill a large part of your life - make it meaningful!"
    ];
    setAvatarEmoji("💼", "emoji-bounce");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // School/Study
  if (/(school|study|exam|test)/i.test(lowerInput)) {
    const responses = [
      "📚 Education is the most powerful weapon you can use to change the world!",
      "🎓 The expert in anything was once a beginner! Keep studying!",
      "✏️ Don't stress about exams - you've prepared and you'll do great!",
      "🧠 Learning is a treasure that will follow its owner everywhere!",
      "📝 Study tip: Take breaks every 45-50 minutes for better retention!",
      "🏫 School is important, but don't forget to nurture your passions too!"
    ];
    setAvatarEmoji("📚", "emoji-shake");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Goals
  if (/(goal|dream|aspiration)/i.test(lowerInput)) {
    const responses = [
      "🎯 A goal without a plan is just a wish! What's your action plan?",
      "🌟 The future belongs to those who believe in the beauty of their dreams!",
      "🚀 Set goals that excite you and scare you at the same time!",
      "🌈 Dream big, start small, but most importantly - start!",
      "⛳ You miss 100% of the shots you don't take! Go for your goals!",
      "🏆 Success is the progressive realization of a worthy goal!"
    ];
    setAvatarEmoji("🎯", "emoji-spin");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Stress
  if (/(stress|overwhelmed|too much)/i.test(lowerInput)) {
    const responses = [
      "🧘‍♀️ Breathe. You've survived 100% of your bad days so far!",
      "🌊 You're not drowning, you're just learning to swim in new waters!",
      "💆‍♂️ Self-care isn't selfish! Take time to recharge when needed!",
      "🛁 Stress relief tip: Try a warm bath, meditation, or a walk in nature!",
      "🌱 This stressful time is just one chapter - not your whole story!",
      "🤗 You're stronger than you think! One step at a time!"
    ];
    setAvatarEmoji("🧘‍♀️", "emoji-heartbeat");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Health
  if (/(health|sick|ill|not feeling well)/i.test(lowerInput)) {
    const responses = [
      "🤒 Rest is part of recovery! Listen to your body and take it easy!",
      "🍵 Hot tea, good sleep, and time - the best medicine for minor illnesses!",
      "🏥 If symptoms persist, please consult a healthcare professional!",
      "💊 Prevention is better than cure! Don't skip those check-ups!",
      "🥦 Your health is an investment, not an expense! Take care of yourself!",
      "🌿 Healing isn't linear - be patient with your body!"
    ];
    setAvatarEmoji("🤒", "emoji-heartbeat");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  // Random thoughts
  if (/(meaning of life|why are we here)/i.test(lowerInput)) {
    const responses = [
      "🤔 42! (According to The Hitchhiker's Guide to the Galaxy)",
      "🌻 To find joy, help others, and leave the world better than we found it!",
      "💖 Life's meaning is whatever you ascribe to it! Make yours beautiful!",
      "🌈 We're here to experience, learn, love, and grow!",
      "🌟 The meaning of life is to give life meaning!",
      "🦋 Like a butterfly, life is short and beautiful - make it count!"
    ];
    setAvatarEmoji("🤔", "emoji-spin");
    addMessage("Maya", `<span class='emoji'>${responses[Math.floor(Math.random() * responses.length)]}</span>`, "bot");
    return true;
  }
  
  return false;
}

function quickReply(text) {
  document.getElementById("textInput").value = text;
  sendMessage();
}

function handleJournalCreation(inputText) {
  showTypingIndicator();
  
  setTimeout(() => {
    hideTypingIndicator();
    
    switch(journalStep) {
      case 1:
        newJournal.title = inputText;
        setAvatarEmoji("📝", "emoji-bounce");
        addMessage("Maya", "<span class='emoji'>📝</span> What's the content?", "bot");
        journalStep = 2;
        break;
      case 2:
        newJournal.content = inputText;
        setAvatarEmoji("🏷️", "emoji-shake");
        addMessage("Maya", "<span class='emoji'>🏷️</span> What category does this belong to? (e.g., Work, Personal, Achievements)", "bot");
        journalStep = 3;
        break;
      case 3:
        newJournal.category = inputText;
        setAvatarEmoji("😊", "emoji-bounce");
        addMessage("Maya", "<span class='emoji'>😊</span> How are you feeling? (e.g., 😊, 😢, 😠)", "bot");
        journalStep = 4;
        break;
      case 4:
        newJournal.mood = inputText;
        setAvatarEmoji(newJournal.mood, "emoji-bounce");
        addMessage("Maya", "<span class='emoji'>📅</span> What's the date? (YYYY-MM-DD format)", "bot");
        journalStep = 5;
        break;
      case 5:
        newJournal.date = inputText;
        setAvatarEmoji("💾", "emoji-spin");
        saveJournal(newJournal.title, newJournal.content, newJournal.category, newJournal.mood, newJournal.date);
        journalStep = 0;
        newJournal = {};
        break;
    }
  }, 800);
}

function saveJournal(title, content, category, mood, date) {
  journalRef.push({
    title,
    content,
    category,
    mood,
    date,
    timestamp: Date.now()
  }, function(error) {
    if (error) {
      setAvatarEmoji("❌", "emoji-shake");
      addMessage("Maya", "<span class='emoji'>❌</span> Journal entry not saved.", "bot");
    } else {
      setAvatarEmoji("✅", "emoji-heartbeat");
      addMessage("Maya", "<span class='emoji'>✅</span> Journal entry saved successfully!", "bot");
      createConfetti();
    }
  });
}

function getAllJournals() {
  journalRef.once('value', snapshot => {
    const data = snapshot.val();
    if (data) {
      let message = "<b>Your Journal Entries:</b><br><br>";
      Object.values(data).forEach(entry => {
        message += `<div class="journal-entry">
          <b>${entry.title}</b> | ${entry.date} | Mood: ${entry.mood}<br>
          ${entry.content}
          <hr>
        </div>`;
      });
      addMessage("Maya", message, "bot");
    } else {
      setAvatarEmoji("😐", "emoji-shake");
      addMessage("Maya", "<span class='emoji'>😐</span> No journal entries found.", "bot");
    }
  });
}

function getJournalsByMood(mood) {
  journalRef.once('value', snapshot => {
    const data = snapshot.val();
    if (data) {
      let message = `<b>Journals with mood ${mood}:</b><br><br>`;
      Object.values(data).forEach(entry => {
        if (entry.mood === mood) {
          message += `<div class="journal-entry">
            <b>${entry.title}</b> | ${entry.date}<br>
            ${entry.content}
            <hr>
          </div>`;
        }
      });
      message ? addMessage("Maya", message, "bot") : 
        (setAvatarEmoji("😐", "emoji-shake"), 
        addMessage("Maya", `<span class='emoji'>😐</span> No entries found for mood ${mood}.`, "bot"));
    }
  });
}

function getJournalsByCategory(category) {
  journalRef.once('value', snapshot => {
    const data = snapshot.val();
    if (data) {
      let message = `<b>Journals in category ${category}:</b><br><br>`;
      Object.values(data).forEach(entry => {
        if (entry.category.toLowerCase() === category.toLowerCase()) {
          message += `<div class="journal-entry">
            <b>${entry.title}</b> | ${entry.date}<br>
            ${entry.content}
            <hr>
          </div>`;
        }
      });
      message ? addMessage("Maya", message, "bot") : 
        (setAvatarEmoji("😐", "emoji-shake"), 
        addMessage("Maya", `<span class='emoji'>😐</span> No entries found for category ${category}.`, "bot"));
    }
  });
}

function getJournalsByDate(date) {
  journalRef.once('value', snapshot => {
    const data = snapshot.val();
    if (data) {
      let message = `<b>Journals on ${date}:</b><br><br>`;
      Object.values(data).forEach(entry => {
        if (entry.date === date) {
          message += `<div class="journal-entry">
            <b>${entry.title}</b> | Mood: ${entry.mood}<br>
            ${entry.content}
            <hr>
          </div>`;
        }
      });
      message ? addMessage("Maya", message, "bot") : 
        (setAvatarEmoji("😐", "emoji-shake"), 
        addMessage("Maya", `<span class='emoji'>😐</span> No entries found for date ${date}.`, "bot"));
    }
  });
}

function saveTask(subject, text, priority, date) {
  taskRef.push({
    subject,
    text,
    priority,
    date,
    completed: false,
    timestamp: Date.now()
  }, function(error) {
    if (error) {
      setAvatarEmoji("❌", "emoji-shake");
      addMessage("Maya", "<span class='emoji'>❌</span> Task not saved.", "bot");
    } else {
      setAvatarEmoji("✅", "emoji-heartbeat");
      addMessage("Maya", "<span class='emoji'>✅</span> Task saved successfully!", "bot");
      createConfetti();
    }
  });
}

function getAllTasks() {
  taskRef.once('value', snapshot => {
    const data = snapshot.val();
    if (data) {
      let message = "<b>Your Tasks:</b><br><br>";
      let taskNumber = 1;
      Object.entries(data).forEach(([key, task]) => {
        if (!task.completed) {
          message += `<div class="task-entry">
            ${taskNumber}. <b>${task.subject}</b> | Priority: ${task.priority} | Due: ${task.date}<br>
            ${task.text}
            <hr>
          </div>`;
          taskNumber++;
        }
      });
      message ? addMessage("Maya", message, "bot") : 
        (setAvatarEmoji("😐", "emoji-shake"), 
        addMessage("Maya", "<span class='emoji'>😐</span> No pending tasks found.", "bot"));
    } else {
      setAvatarEmoji("😐", "emoji-shake");
      addMessage("Maya", "<span class='emoji'>😐</span> No tasks found.", "bot");
    }
  });
}

function completeTask(number) {
  taskRef.once('value', snapshot => {
    const data = snapshot.val();
    if (data) {
      let taskNumber = 1;
      let taskKey = null;
      
      for (const [key, task] of Object.entries(data)) {
        if (!task.completed) {
          if (taskNumber === number) {
            taskKey = key;
            break;
          }
          taskNumber++;
        }
      }
      
      if (taskKey) {
        taskRef.child(taskKey).update({ completed: true }, function(error) {
          if (error) {
            setAvatarEmoji("❌", "emoji-shake");
            addMessage("Maya", "<span class='emoji'>❌</span> Task not completed.", "bot");
          } else {
            setAvatarEmoji("🎉", "emoji-heartbeat");
            addMessage("Maya", `<span class='emoji'>✅</span> Task number ${number} completed!`, "bot");
            createConfetti();
          }
        });
      } else {
        setAvatarEmoji("😐", "emoji-shake");
        addMessage("Maya", "<span class='emoji'>😐</span> Task number not found.", "bot");
      }
    }
  });
}

function showHelp() {
  addMessage("Maya", `<b>📋 Commands List:</b><br><br>
  <b>Journal:</b><br>
  - new journal<br>
  - show all journals<br>
  - show journals with mood 😊<br>
  - show journals in category Achievements<br>
  - show journals on 2025-04-15<br><br>
  
  <b>Tasks:</b><br>
  - new task: subject | text | priority | date<br>
  - show my tasks / show task list<br>
  - complete task number 2<br><br>
  
  <b>Finance:</b><br>
  - add income: amount | category | date | description<br>
  - add expense: amount | category | date | description<br>
  - show income<br>
  - show expenses<br>
  - show balance<br>
  
  <b>Casual Chat:</b><br>
  - Hi / Hello / Hey<br>
  - How are you?<br>
  - Tell me a joke<br>
  - What time is it?<br>
  - What can you do?<br>
  - Thank you<br>
  - Goodbye<br>
  `, "bot");
}

function addFinanceEntry(amount, category, date, desc, type) {
  financeRef.push({ amount, category, date, desc, type, timestamp: Date.now() }, function(error) {
    if (error) {
      setAvatarEmoji("❌", "emoji-shake");
      addMessage("Maya", `<span class='emoji'>❌</span> ${type === 'income' ? 'Income' : 'Expense'} entry not saved.`, "bot");
    } else {
      setAvatarEmoji("✅", "emoji-heartbeat");
      addMessage("Maya", `<span class='emoji'>✅</span> ${type === 'income' ? 'Income' : 'Expense'} entry saved successfully!`, "bot");
      createConfetti();
    }
  });
}

function showFinanceEntries(type) {
  financeRef.once('value', snapshot => {
    const data = snapshot.val();
    if (data) {
      let message = `<b>${type === 'income' ? 'Income' : 'Expenses'}:</b><br><br>`;
      Object.values(data).forEach(entry => {
        if (entry.type === type) {
          message += `<div class="finance-entry ${type === 'income' ? 'finance-positive' : 'finance-negative'}">
            ${type === 'income' ? '💸' : '💳'} ${entry.amount} | ${entry.category} | ${entry.date}<br>
            ${entry.desc}
            <hr>
          </div>`;
        }
      });
      message ? addMessage("Maya", message, "bot") : 
        (setAvatarEmoji("😐", "emoji-shake"), 
        addMessage("Maya", `<span class='emoji'>😐</span> No ${type} entries found.`, "bot"));
    }
  });
}

function showBalance() {
  financeRef.once('value', snapshot => {
    const data = snapshot.val();
    let income = 0, expense = 0;
    if (data) {
      Object.values(data).forEach(entry => {
        if (entry.type === 'income') income += entry.amount;
        if (entry.type === 'expense') expense += entry.amount;
      });
      const balance = income - expense;
      const balanceClass = balance >= 0 ? 'finance-positive' : 'finance-negative';
      addMessage("Maya", `<span class="${balanceClass}">💰 Total Balance: ₹${balance.toFixed(2)}</span>`, "bot");
    } else {
      setAvatarEmoji("😐", "emoji-shake");
      addMessage("Maya", "<span class='emoji'>😐</span> No finance data found.", "bot");
    }
  });
}

// Import bot extension functionality
function importBotExtension(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const content = e.target.result;
      const parser = new DOMParser();
      const doc = parser.parseFromString(content, "text/html");
      
      // Extract script content
      const scripts = doc.querySelectorAll('script');
      scripts.forEach(script => {
        if (script.textContent.trim()) {
          try {
            // Save the extension to Firebase
            extensionsRef.push({
              name: file.name,
              content: script.textContent,
              timestamp: Date.now()
            }, function(error) {
              if (error) {
                setAvatarEmoji("❌", "emoji-shake");
                addMessage("Maya", `<span class='emoji'>❌</span> Error saving extension to database.`, "bot");
              } else {
                // Execute the script content
                new Function(script.textContent)();
                setAvatarEmoji("✅", "emoji-heartbeat");
                addMessage("Maya", "<span class='emoji'>✅</span> Bot extension imported and saved successfully!", "bot");
                createConfetti();
              }
            });
          } catch (error) {
            console.error("Error executing imported script:", error);
            setAvatarEmoji("❌", "emoji-shake");
            addMessage("Maya", `<span class='emoji'>❌</span> Error importing extension: ${error.message}`, "bot");
          }
        }
      });
      
      // Reset file input
      event.target.value = '';
    } catch (error) {
      console.error("Error importing bot extension:", error);
      setAvatarEmoji("❌", "emoji-shake");
      addMessage("Maya", `<span class='emoji'>❌</span> Error importing extension: ${error.message}`, "bot");
    }
  };
  reader.readAsText(file);
}

// Load saved extensions when the page loads
function loadExtensions() {
  extensionsRef.once('value', snapshot => {
    const data = snapshot.val();
    if (data) {
      Object.values(data).forEach(extension => {
        try {
          new Function(extension.content)();
          console.log(`Loaded extension: ${extension.name}`);
        } catch (error) {
          console.error(`Error loading extension ${extension.name}:`, error);
        }
      });
    }
  });
}

// Reset bot to original state
function resetBot() {
  // Restore original functions
  if (originalBotState.handleUserInput) {
    handleUserInput = originalBotState.handleUserInput;
  }
  if (originalBotState.handleCasualConversation) {
    handleCasualConversation = originalBotState.handleCasualConversation;
  }
  if (originalBotState.showHelp) {
    showHelp = originalBotState.showHelp;
  }
  
  // Clear all extensions from Firebase
  extensionsRef.remove(function(error) {
    if (error) {
      setAvatarEmoji("❌", "emoji-shake");
      addMessage("Maya", "<span class='emoji'>❌</span> Error resetting extensions.", "bot");
    } else {
      // Clear chat and show confirmation
      clearChat();
      setAvatarEmoji("🔄", "emoji-spin");
      addMessage("Maya", "<span class='emoji'>🔄</span> Bot has been reset to its original state and all extensions removed.", "bot");
    }
  });
}

// Initial greeting and load extensions
window.onload = function() {
  loadExtensions();
  
  setTimeout(() => {
    setAvatarEmoji("👋", "emoji-bounce");
    addMessage("Maya", `<span class='emoji'>👋</span> Hi there! I'm Maya, your personal assistant. How can I help you today?<br>
      Try saying:<br>
      <div class="quick-reply" onclick="quickReply('help')">help</div>
      <div class="quick-reply" onclick="quickReply('How are you?')">How are you?</div>
      <div class="quick-reply" onclick="quickReply('What can you do?')">What can you do?</div>
    `, "bot");
  }, 500);
};
</script>

</body>
</html>